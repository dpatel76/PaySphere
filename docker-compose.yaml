# GPS CDM - Full Stack Docker Compose
#
# Usage:
#   docker-compose up -d                    # Start all services
#   docker-compose up -d --build            # Rebuild and start
#   docker-compose logs -f                  # Follow logs
#   docker-compose down                     # Stop all services
#   docker-compose down -v                  # Stop and remove volumes
#
# Services:
#   - frontend (port 3000)   - React UI
#   - api (port 8000)        - FastAPI backend
#   - celery                 - Celery worker(s)
#   - nifi (port 8080)       - Apache NiFi flow orchestration
#   - flower (port 5555)     - Celery monitoring
#   - redis (port 6379)      - Message broker
#   - postgres (port 5433)   - PostgreSQL database
#   - neo4j (ports 7474,7687) - Knowledge graph
#
# Access:
#   Frontend: http://localhost:3000
#   API Docs: http://localhost:8000/docs
#   NiFi:     http://localhost:8080/nifi (admin/adminpassword123)
#   Flower:   http://localhost:5555 (admin/flowerpassword)
#   Neo4j:    http://localhost:7474 (neo4j/neo4jpassword123)

services:
  # =========================================================================
  # Application Services
  # =========================================================================

  # Frontend - React UI served by Nginx
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=/api/v1
    container_name: gps-cdm-frontend
    ports:
      - "3000:80"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - gps-cdm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # API - FastAPI Backend
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: gps-cdm-api
    ports:
      - "8000:8000"
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=gps_cdm
      - POSTGRES_USER=gps_cdm_svc
      - POSTGRES_PASSWORD=gps_cdm_password
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=neo4jpassword123
      - REDIS_URL=redis://redis:6379/0
      - NIFI_URL=http://nifi:8080/nifi-api
      - FLOWER_URL=http://flower:5555
      - FLOWER_USER=admin
      - FLOWER_PASSWORD=flowerpassword
      - GPS_CDM_DATA_SOURCE=postgresql
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - gps-cdm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Celery Workers
  celery:
    build:
      context: .
      dockerfile: Dockerfile.celery
    container_name: gps-cdm-celery
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=gps_cdm
      - POSTGRES_USER=gps_cdm_svc
      - POSTGRES_PASSWORD=gps_cdm_password
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=neo4jpassword123
      - CELERY_BROKER_URL=redis://redis:6379/0
      - GPS_CDM_DATA_SOURCE=postgresql
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - gps-cdm-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G

  # Celery Beat - Scheduled Tasks (optional)
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile.celery
    container_name: gps-cdm-celery-beat
    command: ["celery", "-A", "gps_cdm.orchestration.celery_tasks", "beat", "--loglevel=info"]
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=gps_cdm
      - POSTGRES_USER=gps_cdm_svc
      - POSTGRES_PASSWORD=gps_cdm_password
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=neo4jpassword123
      - CELERY_BROKER_URL=redis://redis:6379/0
      - GPS_CDM_DATA_SOURCE=postgresql
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - gps-cdm-network
    restart: unless-stopped

  # =========================================================================
  # Infrastructure Services
  # =========================================================================

  # Apache NiFi - Flow Orchestration
  nifi:
    image: apache/nifi:1.25.0
    container_name: gps-cdm-nifi
    ports:
      - "8080:8080"
      - "8443:8443"
    environment:
      - NIFI_WEB_HTTP_PORT=8080
      - SINGLE_USER_CREDENTIALS_USERNAME=admin
      - SINGLE_USER_CREDENTIALS_PASSWORD=adminpassword123
    volumes:
      - nifi_data:/opt/nifi/nifi-current/data
      - nifi_logs:/opt/nifi/nifi-current/logs
      - ./nifi/templates:/opt/nifi/nifi-current/conf/templates:ro
    networks:
      - gps-cdm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/nifi-api/system-diagnostics"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Redis - Message Broker
  redis:
    image: redis:7-alpine
    container_name: gps-cdm-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - gps-cdm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Flower - Celery Monitoring
  flower:
    image: mher/flower:2.0
    container_name: gps-cdm-flower
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - FLOWER_PORT=5555
      - FLOWER_BASIC_AUTH=admin:flowerpassword
    depends_on:
      - redis
    networks:
      - gps-cdm-network
    restart: unless-stopped
    command: celery --broker=redis://redis:6379/0 flower

  # PostgreSQL - Data Persistence
  postgres:
    image: postgres:16-alpine
    container_name: gps-cdm-postgres
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=gps_cdm
      - POSTGRES_USER=gps_cdm_svc
      - POSTGRES_PASSWORD=gps_cdm_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./ddl/postgresql:/docker-entrypoint-initdb.d:ro
    networks:
      - gps-cdm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gps_cdm_svc -d gps_cdm"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j - Knowledge Graph
  neo4j:
    image: neo4j:5.15-community
    container_name: gps-cdm-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/neo4jpassword123
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - ./cdm/physical-model/neo4j:/import:ro
    networks:
      - gps-cdm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  gps-cdm-network:
    driver: bridge

volumes:
  nifi_data:
  nifi_logs:
  redis_data:
  postgres_data:
  neo4j_data:
  neo4j_logs:
