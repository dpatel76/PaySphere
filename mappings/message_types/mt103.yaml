# GPS CDM - MT103 Full Mapping
# SWIFT Single Customer Credit Transfer
#
# This file defines the complete transformation:
#   Bronze (raw MT) → Silver (stg_mt103) → Gold (cdm_payment_instruction)
#
# Reference: /documents/mappings/standards/SWIFT_MT103_SingleCustomerCreditTransfer_Mapping.md

version: "2.0"

mapping:
  id: MT103_FULL
  name: "SWIFT MT103 Single Customer Credit Transfer"
  message_type: "MT103"
  message_version: "SRG2023"
  description: |
    Complete Bronze→Silver→Gold transformation for SWIFT MT103 messages.
    Supports all MT103 variants including STP and REMIT.

  # ============================================================================
  # STAGE 1: BRONZE → SILVER (Parse raw MT to structured staging)
  # ============================================================================
  bronze_to_silver:
    source:
      layer: bronze
      table: raw_payment_messages
      content_column: raw_content
      format: SWIFT_MT
      parser: swift
      message_type: MT103
      filter:
        message_type: "MT103"

    target:
      layer: silver
      table: stg_mt103

    fields:
      # --- Block 1: Basic Header ---
      - source: "block1.application_id"
        target: application_id
        type: string
        max_length: 1

      - source: "block1.service_id"
        target: service_id
        type: string
        max_length: 2

      - source: "block1.logical_terminal"
        target: sender_logical_terminal
        type: string
        max_length: 12

      - source: "block1.session_number"
        target: session_number
        type: string
        max_length: 4

      - source: "block1.sequence_number"
        target: sequence_number
        type: string
        max_length: 6

      # --- Block 2: Application Header ---
      - source: "block2.message_type"
        target: message_type_code
        type: string
        max_length: 3

      - source: "block2.receiver_address"
        target: receiver_logical_terminal
        type: string
        max_length: 12

      - source: "block2.priority"
        target: priority
        type: string
        max_length: 1

      - source: "block2.delivery_monitoring"
        target: delivery_monitoring
        type: string
        max_length: 1

      - source: "block2.obsolescence_period"
        target: obsolescence_period
        type: string
        max_length: 3

      # --- Field 20: Sender's Reference ---
      - source: "20"
        target: senders_reference
        type: string
        required: true
        max_length: 16

      # --- Field 21: Related Reference ---
      - source: "21"
        target: related_reference
        type: string
        max_length: 16

      # --- Field 13C: Time Indication ---
      - source: "13C"
        target: time_indication
        type: string
        max_length: 30

      # --- Field 23B: Bank Operation Code ---
      - source: "23B"
        target: bank_operation_code
        type: string
        required: true
        max_length: 4

      # --- Field 23E: Instruction Code ---
      - source: "23E"
        target: instruction_code
        type: string
        max_length: 30
        notes: "May be repeated up to 6 times"

      # --- Field 26T: Transaction Type Code ---
      - source: "26T"
        target: transaction_type_code
        type: string
        max_length: 3

      # --- Field 32A: Value Date/Currency/Amount ---
      - source: "32A"
        target: field_32a_raw
        type: string
        required: true
        max_length: 24

      - source: "32A"
        target: value_date
        type: date
        required: true
        transform:
          type: regex
          pattern: "^(\\d{6})"
          group: 1
          date_format: "YYMMDD"

      - source: "32A"
        target: currency
        type: string
        required: true
        max_length: 3
        transform:
          type: regex
          pattern: "^\\d{6}([A-Z]{3})"
          group: 1

      - source: "32A"
        target: amount
        type: decimal
        precision: 18
        scale: 2
        required: true
        transform:
          type: custom
          function: parse_swift_amount
          input_pattern: "^\\d{6}[A-Z]{3}(.+)$"

      # --- Field 33B: Currency/Instructed Amount ---
      - source: "33B"
        target: instructed_currency
        type: string
        max_length: 3
        transform:
          type: regex
          pattern: "^([A-Z]{3})"
          group: 1

      - source: "33B"
        target: instructed_amount
        type: decimal
        precision: 18
        scale: 2
        transform:
          type: custom
          function: parse_swift_amount

      # --- Field 36: Exchange Rate ---
      - source: "36"
        target: exchange_rate
        type: decimal
        precision: 12
        scale: 6

      # --- Field 50a: Ordering Customer ---
      - source: "50A"
        target: ordering_customer_option
        type: string
        transform:
          type: constant
          value: "A"

      - source: "50A"
        target: ordering_customer_account
        type: string
        max_length: 34
        transform:
          type: regex
          pattern: "^/?([^\\n]+)"
          group: 1

      - source: "50A"
        target: ordering_customer_bic
        type: string
        max_length: 11
        transform:
          type: regex
          pattern: "\\n?([A-Z]{4}[A-Z]{2}[A-Z0-9]{2}[A-Z0-9]{3}?)$"
          group: 1

      - source: "50F"
        target: ordering_customer_option
        type: string
        transform:
          type: constant
          value: "F"

      - source: "50F"
        target: ordering_customer_party_id
        type: string
        max_length: 35
        transform:
          type: regex
          pattern: "^/?([^\\n]+)"
          group: 1

      - source: "50F"
        target: ordering_customer_name
        type: string
        max_length: 35
        transform:
          type: regex
          pattern: "\\n1/(.+?)(?:\\n|$)"
          group: 1

      - source: "50F"
        target: ordering_customer_address_line1
        type: string
        max_length: 35
        transform:
          type: regex
          pattern: "\\n2/(.+?)(?:\\n|$)"
          group: 1

      - source: "50F"
        target: ordering_customer_country
        type: string
        max_length: 2
        transform:
          type: regex
          pattern: "\\n3/([A-Z]{2})"
          group: 1

      - source: "50K"
        target: ordering_customer_option
        type: string
        transform:
          type: constant
          value: "K"

      - source: "50K"
        target: ordering_customer_account
        type: string
        max_length: 34
        transform:
          type: regex
          pattern: "^/?([^\\n]+)"
          group: 1

      - source: "50K"
        target: ordering_customer_name
        type: string
        max_length: 35
        transform:
          type: split
          delimiter: "\\n"
          index: 1

      - source: "50K"
        target: ordering_customer_address
        type: string
        max_length: 140
        transform:
          type: custom
          function: extract_address_lines
          skip_first: 2

      # --- Field 52a: Ordering Institution ---
      - source: "52A"
        target: ordering_institution_option
        type: string
        transform:
          type: constant
          value: "A"

      - source: "52A"
        target: ordering_institution_bic
        type: string
        max_length: 11
        transform:
          type: regex
          pattern: "([A-Z]{4}[A-Z]{2}[A-Z0-9]{2}[A-Z0-9]{3}?)"
          group: 1

      - source: "52D"
        target: ordering_institution_option
        type: string
        transform:
          type: constant
          value: "D"

      - source: "52D"
        target: ordering_institution_name
        type: string
        max_length: 140

      # --- Field 53a: Sender's Correspondent ---
      - source: "53A"
        target: senders_correspondent_option
        type: string
        transform:
          type: constant
          value: "A"

      - source: "53A"
        target: senders_correspondent_bic
        type: string
        max_length: 11

      - source: "53B"
        target: senders_correspondent_option
        type: string
        transform:
          type: constant
          value: "B"

      - source: "53B"
        target: senders_correspondent_location
        type: string
        max_length: 35

      - source: "53D"
        target: senders_correspondent_name
        type: string
        max_length: 140

      # --- Field 54a: Receiver's Correspondent ---
      - source: "54A"
        target: receivers_correspondent_bic
        type: string
        max_length: 11

      - source: "54D"
        target: receivers_correspondent_name
        type: string
        max_length: 140

      # --- Field 55a: Third Reimbursement Institution ---
      - source: "55A"
        target: third_reimbursement_bic
        type: string
        max_length: 11

      # --- Field 56a: Intermediary Institution ---
      - source: "56A"
        target: intermediary_institution_bic
        type: string
        max_length: 11

      - source: "56C"
        target: intermediary_institution_account
        type: string
        max_length: 34

      - source: "56D"
        target: intermediary_institution_name
        type: string
        max_length: 140

      # --- Field 57a: Account With Institution ---
      - source: "57A"
        target: account_with_institution_bic
        type: string
        max_length: 11

      - source: "57B"
        target: account_with_institution_location
        type: string
        max_length: 35

      - source: "57C"
        target: account_with_institution_account
        type: string
        max_length: 34

      - source: "57D"
        target: account_with_institution_name
        type: string
        max_length: 140

      # --- Field 59a: Beneficiary Customer ---
      - source: "59"
        target: beneficiary_option
        type: string
        transform:
          type: constant
          value: "NO_LETTER"

      - source: "59"
        target: beneficiary_account
        type: string
        max_length: 34
        transform:
          type: regex
          pattern: "^/?([^\\n]+)"
          group: 1

      - source: "59"
        target: beneficiary_name
        type: string
        max_length: 35
        transform:
          type: split
          delimiter: "\\n"
          index: 1

      - source: "59"
        target: beneficiary_address
        type: string
        max_length: 140
        transform:
          type: custom
          function: extract_address_lines
          skip_first: 2

      - source: "59A"
        target: beneficiary_option
        type: string
        transform:
          type: constant
          value: "A"

      - source: "59A"
        target: beneficiary_bic
        type: string
        max_length: 11
        transform:
          type: regex
          pattern: "([A-Z]{4}[A-Z]{2}[A-Z0-9]{2}[A-Z0-9]{3}?)"
          group: 1

      - source: "59F"
        target: beneficiary_option
        type: string
        transform:
          type: constant
          value: "F"

      - source: "59F"
        target: beneficiary_party_id
        type: string
        max_length: 35
        transform:
          type: regex
          pattern: "^/?([^\\n]+)"
          group: 1

      - source: "59F"
        target: beneficiary_name
        type: string
        max_length: 35
        transform:
          type: regex
          pattern: "\\n1/(.+?)(?:\\n|$)"
          group: 1

      - source: "59F"
        target: beneficiary_address_line1
        type: string
        max_length: 35
        transform:
          type: regex
          pattern: "\\n2/(.+?)(?:\\n|$)"
          group: 1

      - source: "59F"
        target: beneficiary_country
        type: string
        max_length: 2
        transform:
          type: regex
          pattern: "\\n3/([A-Z]{2})"
          group: 1

      # --- Field 70: Remittance Information ---
      - source: "70"
        target: remittance_information
        type: string
        max_length: 140

      # --- Field 71A: Details of Charges ---
      - source: "71A"
        target: details_of_charges
        type: string
        required: true
        max_length: 3

      # --- Field 71F: Sender's Charges ---
      - source: "71F"
        target: senders_charges_currency
        type: string
        max_length: 3
        transform:
          type: regex
          pattern: "^([A-Z]{3})"
          group: 1

      - source: "71F"
        target: senders_charges_amount
        type: decimal
        precision: 18
        scale: 2
        transform:
          type: custom
          function: parse_swift_amount

      # --- Field 71G: Receiver's Charges ---
      - source: "71G"
        target: receivers_charges_currency
        type: string
        max_length: 3
        transform:
          type: regex
          pattern: "^([A-Z]{3})"
          group: 1

      - source: "71G"
        target: receivers_charges_amount
        type: decimal
        precision: 18
        scale: 2
        transform:
          type: custom
          function: parse_swift_amount

      # --- Field 72: Sender to Receiver Information ---
      - source: "72"
        target: sender_to_receiver_info
        type: string
        max_length: 420

      # --- Field 77B: Regulatory Reporting ---
      - source: "77B"
        target: regulatory_reporting
        type: string
        max_length: 105

      # --- Field 77T: Envelope Contents ---
      - source: "77T"
        target: envelope_contents
        type: string

      # --- Block 5: Trailer ---
      - source: "block5.CHK"
        target: checksum
        type: string
        max_length: 12

      - source: "block5.TNG"
        target: training_flag
        type: boolean
        transform:
          type: expression
          expr: "source IS NOT NULL"

      - source: "block5.PDE"
        target: possible_duplicate_emission
        type: string
        max_length: 40

      - source: "block5.PDM"
        target: possible_duplicate_message
        type: string
        max_length: 40

  # ============================================================================
  # STAGE 2: SILVER → GOLD (Structured staging to unified CDM)
  # ============================================================================
  silver_to_gold:
    source:
      layer: silver
      table: stg_mt103
      filter:
        processing_status: "PENDING"

    target:
      layer: gold
      table: cdm_payment_instruction
      source_message_type: "MT103"
      source_stg_table: "stg_mt103"

    fields:
      # --- Primary Identifiers ---
      - source: stg_id
        target: source_stg_id
        type: string
        required: true

      - source: senders_reference
        target: end_to_end_id
        type: string
        required: true
        notes: "MT103 uses Field 20 as end-to-end reference"

      - source: related_reference
        target: related_reference
        type: string

      # --- Classification ---
      - target: payment_type
        type: string
        transform:
          type: constant
          value: "CREDIT_TRANSFER"

      - source: bank_operation_code
        target: scheme_code
        type: string
        transform:
          type: lookup
          mapping:
            CRED: "SWIFT_CREDIT"
            CRTS: "SWIFT_STP"
            SPAY: "SWIFT_SPECIAL"
            SPRI: "SWIFT_PRIORITY"
            SSTD: "SWIFT_STANDARD"
          default: "SWIFT_CREDIT"

      - target: direction
        type: string
        transform:
          type: expression
          expr: |
            CASE
              WHEN sender_logical_terminal LIKE '%XXXXXX%' THEN 'OUTBOUND'
              ELSE 'INBOUND'
            END

      - source: ordering_customer_country
        target: cross_border_flag
        type: boolean
        transform:
          type: expression
          expr: "ordering_customer_country != beneficiary_country"

      - source: priority
        target: priority
        type: string
        transform:
          type: lookup
          mapping:
            S: "HIGH"
            U: "URGENT"
            N: "NORM"
          default: "NORM"

      - source: instruction_code
        target: local_instrument
        type: string

      # --- Amounts ---
      - source: amount
        target: instructed_amount
        type: decimal
        required: true

      - source: currency
        target: instructed_currency
        type: string
        required: true

      - source: instructed_amount
        target: interbank_settlement_amount
        type: decimal

      - source: instructed_currency
        target: interbank_settlement_currency
        type: string

      - source: exchange_rate
        target: exchange_rate
        type: decimal

      # --- Dates ---
      - source: value_date
        target: requested_execution_date
        type: date

      - source: value_date
        target: value_date
        type: date

      - source: value_date
        target: settlement_date
        type: date

      # --- Charges ---
      - source: details_of_charges
        target: charge_bearer
        type: string
        transform:
          type: lookup
          mapping:
            OUR: "OUR"
            BEN: "BEN"
            SHA: "SHA"
          default: "SHA"

      # --- Remittance ---
      - source: remittance_information
        target: remittance_unstructured
        type: array
        transform:
          type: split
          delimiter: "\\n"

      # --- Status ---
      - target: current_status
        type: string
        transform:
          type: constant
          value: "RECEIVED"

      # --- Regulatory ---
      - source: regulatory_reporting
        target: regulatory_extensions
        type: json
        transform:
          type: expression
          expr: "jsonb_build_object('swift_77b', regulatory_reporting)"

      # --- Source Tracking ---
      - source: source_system
        target: source_system
        type: string

      - source: raw_message_id
        target: source_raw_id
        type: string

      # --- Partitioning ---
      - source: value_date
        target: partition_year
        type: integer
        transform:
          type: expression
          expr: "EXTRACT(YEAR FROM value_date)"

      - source: value_date
        target: partition_month
        type: integer
        transform:
          type: expression
          expr: "EXTRACT(MONTH FROM value_date)"

      - source: ordering_customer_country
        target: region
        type: string
        transform:
          type: lookup
          table: country_to_region
          default: "GLOBAL"

    # --- Party Entities ---
    party_mappings:
      - role: debtor
        target_table: cdm_party
        fields:
          - source: ordering_customer_name
            target: name
          - source: ordering_customer_bic
            target: bic
          - source: ordering_customer_party_id
            target: identification_number
          - source: ordering_customer_address
            target: address_line1
          - source: ordering_customer_address_line1
            target: address_line1
          - source: ordering_customer_country
            target: country

      - role: creditor
        target_table: cdm_party
        fields:
          - source: beneficiary_name
            target: name
          - source: beneficiary_bic
            target: bic
          - source: beneficiary_party_id
            target: identification_number
          - source: beneficiary_account
            target: account_reference
          - source: beneficiary_address
            target: address_line1
          - source: beneficiary_address_line1
            target: address_line1
          - source: beneficiary_country
            target: country

    # --- Account Entities ---
    account_mappings:
      - role: debtor_account
        target_table: cdm_account
        fields:
          - source: ordering_customer_account
            target: account_number

      - role: creditor_account
        target_table: cdm_account
        fields:
          - source: beneficiary_account
            target: account_number

    # --- Financial Institution Entities ---
    fi_mappings:
      - role: debtor_agent
        target_table: cdm_financial_institution
        fields:
          - source: ordering_institution_bic
            target: bic
          - source: ordering_institution_name
            target: institution_name

      - role: senders_correspondent
        target_table: cdm_financial_institution
        fields:
          - source: senders_correspondent_bic
            target: bic
          - source: senders_correspondent_name
            target: institution_name

      - role: receivers_correspondent
        target_table: cdm_financial_institution
        fields:
          - source: receivers_correspondent_bic
            target: bic
          - source: receivers_correspondent_name
            target: institution_name

      - role: intermediary_agent
        target_table: cdm_financial_institution
        fields:
          - source: intermediary_institution_bic
            target: bic
          - source: intermediary_institution_name
            target: institution_name

      - role: creditor_agent
        target_table: cdm_financial_institution
        fields:
          - source: account_with_institution_bic
            target: bic
          - source: account_with_institution_name
            target: institution_name

  # ============================================================================
  # VALIDATION RULES
  # ============================================================================
  validations:
    - id: MT103_VAL001
      stage: silver
      rule: "senders_reference IS NOT NULL AND LENGTH(senders_reference) <= 16"
      severity: ERROR
      message: "Field 20 (Sender's Reference) is mandatory and max 16 characters"
      error_code: M50
      dimension: completeness

    - id: MT103_VAL002
      stage: silver
      rule: "amount > 0"
      severity: ERROR
      message: "Amount in Field 32A must be greater than zero"
      error_code: T32
      dimension: validity

    - id: MT103_VAL003
      stage: silver
      rule: "currency IS NOT NULL AND LENGTH(currency) = 3"
      severity: ERROR
      message: "Currency in Field 32A is required and must be 3 characters"
      error_code: T50
      dimension: completeness

    - id: MT103_VAL004
      stage: silver
      rule: "value_date IS NOT NULL"
      severity: ERROR
      message: "Value Date in Field 32A is mandatory"
      error_code: T30
      dimension: completeness

    - id: MT103_VAL005
      stage: silver
      rule: "bank_operation_code IN ('CRED', 'CRTS', 'SPAY', 'SPRI', 'SSTD')"
      severity: ERROR
      message: "Invalid Bank Operation Code in Field 23B"
      error_code: T52
      dimension: validity

    - id: MT103_VAL006
      stage: silver
      rule: "details_of_charges IN ('OUR', 'BEN', 'SHA')"
      severity: ERROR
      message: "Invalid Details of Charges code in Field 71A"
      error_code: T51
      dimension: validity

    - id: MT103_VAL007
      stage: silver
      rule: "beneficiary_name IS NOT NULL OR beneficiary_bic IS NOT NULL"
      severity: ERROR
      message: "Beneficiary (Field 59) must have name or BIC"
      error_code: T73
      dimension: completeness

    - id: MT103_VAL008
      stage: silver
      rule: "ordering_institution_bic IS NULL OR ordering_institution_bic ~ '^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?$'"
      severity: ERROR
      message: "Invalid Ordering Institution BIC format in Field 52A"
      error_code: T26
      dimension: accuracy

    - id: MT103_VAL009
      stage: silver
      rule: "account_with_institution_bic IS NULL OR account_with_institution_bic ~ '^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?$'"
      severity: ERROR
      message: "Invalid Account With Institution BIC format in Field 57A"
      error_code: T26
      dimension: accuracy

    - id: MT103_VAL010
      stage: silver
      rule: "value_date >= CURRENT_DATE - INTERVAL '1 year'"
      severity: WARNING
      message: "Value Date is more than 1 year in the past"
      error_code: DT01
      dimension: timeliness

    - id: MT103_VAL011
      stage: silver
      rule: "instructed_amount IS NULL OR (instructed_amount > 0 AND instructed_currency IS NOT NULL)"
      severity: WARNING
      message: "If Field 33B is present, both amount and currency are required"
      error_code: T33
      dimension: validity

    - id: MT103_VAL012
      stage: silver
      rule: "training_flag IS FALSE OR training_flag IS NULL"
      severity: INFO
      message: "Message is marked as training/test message"
      error_code: TNG
      dimension: validity

  # ============================================================================
  # DATA QUALITY CONFIGURATION
  # ============================================================================
  quality:
    completeness:
      - field: senders_reference
        weight: 1.0
        required: true
      - field: amount
        weight: 1.0
        required: true
      - field: currency
        weight: 1.0
        required: true
      - field: value_date
        weight: 1.0
        required: true
      - field: bank_operation_code
        weight: 1.0
        required: true
      - field: details_of_charges
        weight: 1.0
        required: true
      - field: ordering_customer_name
        weight: 0.9
      - field: beneficiary_name
        weight: 0.9
      - field: ordering_institution_bic
        weight: 0.8
      - field: account_with_institution_bic
        weight: 0.8

    accuracy:
      - field: ordering_institution_bic
        validation: validate_bic
      - field: account_with_institution_bic
        validation: validate_bic
      - field: senders_correspondent_bic
        validation: validate_bic
      - field: intermediary_institution_bic
        validation: validate_bic
      - field: beneficiary_bic
        validation: validate_bic

    timeliness:
      timestamp_field: ingested_at
      max_age_hours: 24

    thresholds:
      overall_pass: 0.80
      completeness_pass: 0.85
      accuracy_pass: 0.90
      validity_pass: 0.95

  # ============================================================================
  # OPTIMIZATION HINTS
  # ============================================================================
  optimization:
    bronze_to_silver:
      batch_size: 1000
      parallel_parse: true
      cache_field_patterns: true

    silver_to_gold:
      batch_size: 5000
      partition_filter: "value_date >= CURRENT_DATE - 30"
      cluster_by:
        - ordering_institution_bic
        - account_with_institution_bic
      broadcast_lookups: true
