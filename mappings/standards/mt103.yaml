# GPS Payments CDM - MT103 Mapping
# SWIFT Single Customer Credit Transfer
#
# Reference: /documents/mappings/standards/SWIFT_MT103_SingleCustomerCreditTransfer_Mapping.md
# Schema Version: 1.0.0

version: "1.0"

mapping:
  id: MT103_SWIFT
  name: "SWIFT MT103 Single Customer Credit Transfer"
  description: |
    Maps SWIFT MT103 messages to GPS Payments CDM entities.
    Supports all MT103 variants including STP and REMIT.
  doc_reference: "/documents/mappings/standards/SWIFT_MT103_SingleCustomerCreditTransfer_Mapping.md"

  # Source configuration
  source:
    format: SWIFT_MT
    parser: swift
    message_type: MT103

  # Field mappings
  fields:
    # ============================================
    # Transaction Reference
    # ============================================
    - source: "20"
      target:
        entity: TransactionReference
        attribute: reference_value
      type: string
      required: true
      max_length: 16
      notes: "Sender's Reference (Field 20)"

    - source: "21"
      target:
        entity: TransactionReference
        attribute: related_reference
      type: string
      max_length: 16
      notes: "Related Reference (Field 21) - optional"

    # ============================================
    # Payment Details - Field 32A
    # ============================================
    - source: "32A"
      target:
        entity: PaymentInstruction
        attribute: settlement_date
      type: date
      transform:
        type: regex
        pattern: "^(\\d{6})"
        group: 1
      notes: "Value Date extracted from 32A (YYMMDD)"

    - source: "32A"
      target:
        entity: PaymentInstruction
        attribute: instructed_currency
      type: string
      transform:
        type: regex
        pattern: "^\\d{6}([A-Z]{3})"
        group: 1
      notes: "Currency extracted from 32A"

    - source: "32A"
      target:
        entity: PaymentInstruction
        attribute: instructed_amount
      type: decimal
      precision: 18
      scale: 2
      transform:
        type: custom
        function: parse_mt_amount
      notes: "Amount extracted from 32A"

    # ============================================
    # Original Instructed Amount - Field 33B
    # ============================================
    - source: "33B"
      target:
        entity: PaymentInstruction
        attribute: original_currency
      type: string
      transform:
        type: regex
        pattern: "^([A-Z]{3})"
        group: 1
      condition: "source IS NOT NULL"

    - source: "33B"
      target:
        entity: PaymentInstruction
        attribute: original_amount
      type: decimal
      transform:
        type: custom
        function: parse_mt_amount
      condition: "source IS NOT NULL"

    # ============================================
    # Exchange Rate - Field 36
    # ============================================
    - source: "36"
      target:
        entity: ExchangeRate
        attribute: rate
      type: decimal
      precision: 12
      scale: 6
      condition: "source IS NOT NULL"

    # ============================================
    # Ordering Customer - Field 50
    # ============================================
    - source: "50A"
      target:
        entity: Party
        attribute: account_number
      type: string
      transform:
        type: regex
        pattern: "^/([^\\n]+)"
        group: 1
      notes: "Account from 50A"

    - source: "50A"
      target:
        entity: Party
        attribute: bic
      type: string
      transform:
        type: regex
        pattern: "\\n([A-Z]{4}[A-Z]{2}[A-Z0-9]{2}[A-Z0-9]{3}?)"
        group: 1

    - source: "50K"
      target:
        entity: Party
        attribute: name
      type: string
      transform:
        type: split
        pattern: "\\n"
        group: 1
      notes: "Name from first line of 50K"

    - source: "50K"
      target:
        entity: Address
        attribute: address_lines
      type: array
      array_type: string
      transform:
        type: split
        pattern: "\\n"
      notes: "Address lines from 50K (lines 2-4)"

    - source: "50F"
      target:
        entity: Party
        attribute: party_identifier
      type: string
      transform:
        type: regex
        pattern: "^/([^\\n]+)"
        group: 1
      notes: "Party identifier from 50F structured format"

    # ============================================
    # Ordering Institution - Field 52
    # ============================================
    - source: "52A"
      target:
        entity: FinancialInstitution
        attribute: bic
      type: string
      transform:
        type: custom
        function: validate_bic
      notes: "Ordering Institution BIC"

    - source: "52D"
      target:
        entity: FinancialInstitution
        attribute: institution_name
      type: string
      transform:
        type: split
        pattern: "\\n"
        group: 0

    # ============================================
    # Sender's Correspondent - Field 53
    # ============================================
    - source: "53A"
      target:
        entity: Agent
        attribute: correspondent_bic
      type: string
      notes: "Sender's Correspondent BIC"

    - source: "53B"
      target:
        entity: Agent
        attribute: correspondent_location
      type: string

    # ============================================
    # Receiver's Correspondent - Field 54
    # ============================================
    - source: "54A"
      target:
        entity: Agent
        attribute: receiver_correspondent_bic
      type: string

    # ============================================
    # Intermediary Institution - Field 56
    # ============================================
    - source: "56A"
      target:
        entity: FinancialInstitution
        attribute: bic
      type: string
      notes: "Intermediary BIC"

    - source: "56D"
      target:
        entity: FinancialInstitution
        attribute: institution_name
      type: string
      transform:
        type: split
        pattern: "\\n"
        group: 0

    # ============================================
    # Account With Institution - Field 57
    # ============================================
    - source: "57A"
      target:
        entity: FinancialInstitution
        attribute: bic
      type: string
      notes: "Account With Institution BIC (Beneficiary Bank)"

    - source: "57D"
      target:
        entity: FinancialInstitution
        attribute: institution_name
      type: string
      transform:
        type: split
        pattern: "\\n"
        group: 0

    # ============================================
    # Beneficiary Customer - Field 59
    # ============================================
    - source: "59"
      target:
        entity: Account
        attribute: account_number
      type: string
      transform:
        type: regex
        pattern: "^/([^\\n]+)"
        group: 1
      notes: "Beneficiary account from 59"

    - source: "59"
      target:
        entity: Party
        attribute: name
      type: string
      transform:
        type: regex
        pattern: "\\n(.+)"
        group: 1
      notes: "Beneficiary name from 59"

    - source: "59A"
      target:
        entity: Party
        attribute: bic
      type: string
      transform:
        type: regex
        pattern: "([A-Z]{4}[A-Z]{2}[A-Z0-9]{2}[A-Z0-9]{3}?)"
        group: 1

    - source: "59F"
      target:
        entity: Party
        attribute: name
      type: string
      transform:
        type: regex
        pattern: "1/(.+)"
        group: 1
      notes: "Beneficiary name from structured 59F"

    - source: "59F"
      target:
        entity: Address
        attribute: country
      type: string
      transform:
        type: regex
        pattern: "3/([A-Z]{2})"
        group: 1

    # ============================================
    # Remittance Information - Field 70
    # ============================================
    - source: "70"
      target:
        entity: PaymentInstruction
        attribute: remittance_information
      type: string
      max_length: 140
      transform:
        type: custom
        function: format_remittance
      notes: "Remittance Information"

    # ============================================
    # Charges - Field 71A/F/G
    # ============================================
    - source: "71A"
      target:
        entity: PaymentInstruction
        attribute: charge_bearer
      type: string
      transform:
        type: lookup
        mapping:
          OUR: "DEBT"
          BEN: "CRED"
          SHA: "SHAR"
        default: "SHAR"
      notes: "Details of Charges"

    - source: "71F"
      target:
        entity: PaymentCharges
        attribute: sender_charges
      type: decimal
      transform:
        type: custom
        function: parse_mt_amount
      notes: "Sender's Charges"

    - source: "71G"
      target:
        entity: PaymentCharges
        attribute: receiver_charges
      type: decimal
      transform:
        type: custom
        function: parse_mt_amount
      notes: "Receiver's Charges"

    # ============================================
    # Sender to Receiver Info - Field 72
    # ============================================
    - source: "72"
      target:
        entity: PaymentInstruction
        attribute: sender_to_receiver_info
      type: string
      notes: "Sender to Receiver Information"

    # ============================================
    # Regulatory Reporting - Field 77B
    # ============================================
    - source: "77B"
      target:
        entity: RegulatoryReporting
        attribute: details
      type: string
      notes: "Regulatory Reporting"

    # ============================================
    # Bank Operation Code - Field 23B
    # ============================================
    - source: "23B"
      target:
        entity: PaymentInstruction
        attribute: bank_operation_code
      type: string
      transform:
        type: lookup
        mapping:
          CRED: "CREDIT"
          CRTS: "CREDIT_TRANSFER_STP"
          SPAY: "SPECIAL_PAYMENT"
          SPRI: "SPECIAL_PRIORITY"
          SSTD: "SPECIAL_STANDARD"
      notes: "Bank Operation Code"

    # ============================================
    # Instruction Code - Field 23E
    # ============================================
    - source: "23E"
      target:
        entity: PaymentInstruction
        attribute: instruction_code
      type: string
      notes: "Instruction Code"

    # ============================================
    # Payment Type - Derived
    # ============================================
    - target:
        entity: Payment
        attribute: payment_type
      transform:
        type: expression
        expr: "'CREDIT_TRANSFER'"
      notes: "Static value for MT103"

  # Validation rules
  validations:
    - id: MT_VAL001
      rule: "TRY_CAST(${PaymentInstruction__instructed_amount} AS DECIMAL(18,2)) IS NULL OR TRY_CAST(${PaymentInstruction__instructed_amount} AS DECIMAL(18,2)) > 0"
      severity: ERROR
      message: "Amount in field 32A must be greater than zero"
      error_code: T32

    - id: MT_VAL002
      rule: "${PaymentInstruction__instructed_currency} IS NOT NULL"
      severity: ERROR
      message: "Currency is required in field 32A"
      error_code: T50

    - id: MT_VAL003
      rule: "${TransactionReference__reference_value} IS NOT NULL"
      severity: ERROR
      message: "Field 20 (Sender's Reference) is mandatory"
      error_code: M50

    - id: MT_VAL004
      rule: "${Party__name} IS NOT NULL"
      severity: ERROR
      message: "Beneficiary name is required"
      error_code: T73

    - id: MT_VAL005
      rule: "${PaymentInstruction__charge_bearer} IS NULL OR ${PaymentInstruction__charge_bearer} IN ('OUR', 'BEN', 'SHA')"
      severity: ERROR
      message: "Invalid charge bearer code in field 71A"
      error_code: T51

  # Data quality configuration
  quality:
    completeness:
      - field: TransactionReference__reference_value
        weight: 1.0
      - field: PaymentInstruction__instructed_amount
        weight: 1.0
      - field: PaymentInstruction__instructed_currency
        weight: 1.0
      - field: Party__name
        weight: 0.9
      - field: FinancialInstitution__bic
        weight: 0.8
    accuracy:
      - field: FinancialInstitution__bic
        validation: "validate_bic"

  # Performance optimization hints
  optimization:
    broadcast_lookups: true
    cache_parsed: false
