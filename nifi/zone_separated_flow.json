{
  "flow_name": "GPS CDM Zone-Separated Payment Pipeline",
  "description": "NiFi flow that publishes raw payment messages to zone-specific Kafka topics",
  "version": "2.1",
  "architecture": "zone_separated",
  "last_synced_from_container": "2026-01-06",

  "overview": {
    "purpose": "Read payment files, detect message type, publish raw content to bronze.{message_type} Kafka topics",
    "data_flow": [
      "1. GetFile reads payment files from input directory",
      "2. UpdateAttribute extracts message_type from filename (using hyphen delimiter) and generates batch_id",
      "3. PublishKafka_2_6 publishes raw content to bronze.{message_type} topic",
      "4. Success auto-terminated, failures routed to Log Failures"
    ]
  },

  "processors": [
    {
      "name": "Read Payment Files",
      "type": "GetFile",
      "state": "RUNNING",
      "config": {
        "Input Directory": "/opt/nifi/nifi-current/input",
        "File Filter": "[^\\.].*\\.(xml|json|txt|ach)$",
        "Batch Size": "100",
        "Keep Source File": "false",
        "Recurse Subdirectories": "true",
        "Polling Interval": "5 sec",
        "Ignore Hidden Files": "true",
        "Minimum File Age": "0 sec",
        "Minimum File Size": "0 B"
      },
      "relationships": {
        "success": "Detect Message Type"
      }
    },

    {
      "name": "Detect Message Type",
      "type": "UpdateAttribute",
      "state": "RUNNING",
      "config": {
        "properties": {
          "batch.id": "${UUID()}",
          "message.type": "${filename:substringBefore('-')}"
        },
        "Store State": "Do not store state",
        "canonical-value-lookup-cache-size": "100"
      },
      "relationships": {
        "success": "Publish to Kafka"
      },
      "notes": [
        "Message type extracted from filename using hyphen (-) delimiter",
        "pain.001-test.xml -> pain.001",
        "MT103-sample.txt -> MT103",
        "FEDWIRE-001.txt -> FEDWIRE",
        "MEPS_PLUS-test.json -> MEPS_PLUS (underscores in type preserved)",
        "RTGS_HK-test.json -> RTGS_HK"
      ]
    },

    {
      "name": "Publish to Kafka",
      "type": "PublishKafka_2_6",
      "state": "RUNNING",
      "config": {
        "bootstrap.servers": "kafka:29092",
        "topic": "bronze.${message.type}",
        "use-transactions": "false",
        "Failure Strategy": "Route to Failure",
        "acks": "all",
        "message-header-encoding": "UTF-8",
        "security.protocol": "PLAINTEXT",
        "key-attribute-encoding": "utf-8",
        "max.request.size": "1 MB",
        "ack.wait.time": "5 secs",
        "max.block.ms": "5 sec",
        "partitioner.class": "org.apache.kafka.clients.producer.internals.DefaultPartitioner",
        "compression.type": "none"
      },
      "relationships": {
        "success": "Auto-terminate",
        "failure": "Log Failures"
      },
      "notes": [
        "Publishes raw content AS-IS (no transformation)",
        "Topic determined by message.type attribute: bronze.pain.001, bronze.MT103, etc.",
        "Success relationship is auto-terminated"
      ]
    },

    {
      "name": "Log Failures",
      "type": "LogAttribute",
      "state": "RUNNING",
      "config": {
        "Log Level": "error",
        "Log Payload": "false",
        "Attributes to Log": ".*",
        "Log FlowFile Properties": "true",
        "Output Format": "Line per Attribute",
        "character-set": "UTF-8"
      },
      "relationships": {
        "success": "Auto-terminate"
      }
    }
  ],

  "connections": [
    {
      "source": "Read Payment Files",
      "destination": "Detect Message Type",
      "relationships": ["success"]
    },
    {
      "source": "Detect Message Type",
      "destination": "Publish to Kafka",
      "relationships": ["success"]
    },
    {
      "source": "Publish to Kafka",
      "destination": "Log Failures",
      "relationships": ["failure"]
    }
  ],

  "message_type_patterns": {
    "description": "Filename patterns to message type mappings (filename prefix before hyphen)",
    "examples": [
      {"filename": "pain.001-test-001.xml", "message_type": "pain.001", "topic": "bronze.pain.001"},
      {"filename": "pacs.008-e2e-test.xml", "message_type": "pacs.008", "topic": "bronze.pacs.008"},
      {"filename": "camt.053-statement.xml", "message_type": "camt.053", "topic": "bronze.camt.053"},
      {"filename": "MT103-sample.txt", "message_type": "MT103", "topic": "bronze.MT103"},
      {"filename": "MT202-e2e-test.txt", "message_type": "MT202", "topic": "bronze.MT202"},
      {"filename": "MT940-statement.txt", "message_type": "MT940", "topic": "bronze.MT940"},
      {"filename": "FEDWIRE-001.txt", "message_type": "FEDWIRE", "topic": "bronze.FEDWIRE"},
      {"filename": "ACH-batch.ach", "message_type": "ACH", "topic": "bronze.ACH"},
      {"filename": "SEPA-payment.xml", "message_type": "SEPA", "topic": "bronze.SEPA"},
      {"filename": "CHAPS-transfer.xml", "message_type": "CHAPS", "topic": "bronze.CHAPS"},
      {"filename": "MEPS_PLUS-test.json", "message_type": "MEPS_PLUS", "topic": "bronze.MEPS_PLUS"},
      {"filename": "RTGS_HK-test.json", "message_type": "RTGS_HK", "topic": "bronze.RTGS_HK"}
    ],
    "supported_formats": [
      "pain.001", "pain.002", "pain.008",
      "pacs.002", "pacs.003", "pacs.004", "pacs.008", "pacs.009",
      "camt.052", "camt.053", "camt.054",
      "MT103", "MT202", "MT940", "MT101", "MT199",
      "FEDWIRE", "ACH", "CHIPS", "RTP", "FEDNOW",
      "CHAPS", "BACS", "FPS", "SEPA", "TARGET2",
      "NPP", "UPI", "PIX", "INSTAPAY", "PAYNOW", "PROMPTPAY",
      "MEPS_PLUS", "CNAPS", "BOJNET", "KFTC", "RTGS_HK", "SARIE", "UAEFTS"
    ]
  },

  "deployment_notes": [
    "1. This config is synced from the live NiFi container (gps-cdm-nifi)",
    "2. File naming convention: {MESSAGE_TYPE}-{identifier}.{extension}",
    "3. The hyphen (-) is the delimiter for extracting message type",
    "4. Underscores in message types (MEPS_PLUS, RTGS_HK) are preserved",
    "5. Zone consumers (Bronze, Silver, Gold) must be running to process messages from Kafka"
  ],

  "testing": {
    "copy_file_command": "docker cp test_data/e2e/pain.001-e2e-test.xml gps-cdm-nifi:/opt/nifi/nifi-current/input/",
    "verify_kafka": "docker exec gps-cdm-kafka kafka-console-consumer --bootstrap-server localhost:9092 --topic bronze.pain.001 --from-beginning --max-messages 1 --timeout-ms 5000",
    "verify_bronze": "docker exec gps-cdm-postgres psql -U gps_cdm_svc -d gps_cdm -c \"SELECT raw_id, message_type FROM bronze.raw_payment_messages ORDER BY _ingested_at DESC LIMIT 5;\""
  }
}
