# GPS CDM - NiFi + Kafka + Celery Integration Stack
#
# Architecture: NiFi → Kafka (per-message-type topics) → Celery consumers
#
# Usage:
#   docker-compose -f docker-compose.nifi.yaml up -d
#
# This starts:
#   - Zookeeper (port 2181) - Kafka coordination
#   - Kafka (port 9092) - Message streaming with per-message-type topics
#   - NiFi (port 8080) - Flow orchestration, publishes to Kafka
#   - Redis (port 6379) - Celery broker
#   - PostgreSQL (port 5433) - Data persistence
#   - Neo4j (port 7474/7687) - Knowledge graph
#
# After startup:
#   1. Create Kafka topics for each message type:
#      for type in pain.001 pacs.008 MT103 FEDWIRE ACH RTP SEPA; do
#        docker exec gps-cdm-kafka kafka-topics --create --topic gps-cdm-$type --bootstrap-server localhost:9092 --partitions 3 --replication-factor 1
#      done
#   2. Start Celery workers: celery -A gps_cdm.orchestration.celery_tasks worker -Q celery,bronze,silver,gold,dq,cdc -l info
#   3. Start Kafka consumers: python -m gps_cdm.streaming.consumer_launcher
#   4. Configure NiFi PublishKafka processor to send to gps-cdm-${message.type} topic

services:
  # Zookeeper - Kafka Coordination
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: gps-cdm-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    networks:
      - gps-cdm-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka - Message Streaming
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: gps-cdm-kafka
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 6
    volumes:
      - kafka_data:/var/lib/kafka/data
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - gps-cdm-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Apache NiFi - Flow Orchestration
  nifi:
    image: apache/nifi:1.25.0
    container_name: gps-cdm-nifi
    ports:
      - "8080:8080"   # NiFi UI
      - "8443:8443"   # NiFi HTTPS (if enabled)
    environment:
      - NIFI_WEB_HTTP_PORT=8080
      - SINGLE_USER_CREDENTIALS_USERNAME=admin
      - SINGLE_USER_CREDENTIALS_PASSWORD=adminpassword123
    volumes:
      - nifi_data:/opt/nifi/nifi-current/data
      - nifi_logs:/opt/nifi/nifi-current/logs
      - ./nifi/templates:/opt/nifi/nifi-current/conf/templates:ro
    networks:
      - gps-cdm-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/nifi-api/system-diagnostics"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Redis - Celery Broker
  redis:
    image: redis:7-alpine
    container_name: gps-cdm-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - gps-cdm-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # PostgreSQL - Data Persistence
  postgres:
    image: postgres:16-alpine
    container_name: gps-cdm-postgres
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=gps_cdm
      - POSTGRES_USER=gps_cdm_svc
      - POSTGRES_PASSWORD=gps_cdm_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./ddl/postgresql:/docker-entrypoint-initdb.d:ro
    networks:
      - gps-cdm-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gps_cdm_svc -d gps_cdm"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j - Knowledge Graph Database
  neo4j:
    image: neo4j:5.15-community
    container_name: gps-cdm-neo4j
    ports:
      - "7474:7474"   # HTTP
      - "7687:7687"   # Bolt
    environment:
      - NEO4J_AUTH=neo4j/neo4jpassword123
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - ./cdm/physical-model/neo4j:/import:ro
    networks:
      - gps-cdm-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  gps-cdm-network:
    driver: bridge

volumes:
  zookeeper_data:
  zookeeper_logs:
  kafka_data:
  nifi_data:
  nifi_logs:
  redis_data:
  postgres_data:
  neo4j_data:
  neo4j_logs:
